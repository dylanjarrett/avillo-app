// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ---------------------------
// ENUMS
// ---------------------------

// Platform-wide role (Avillo staff/admin)
enum UserRole {
  USER
  ADMIN
}

// Workspace membership role (teams)
enum WorkspaceRole {
  OWNER
  ADMIN
  AGENT
}

enum WorkspaceType {
  PERSONAL
  TEAM
}

enum WorkspaceInviteStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum SubscriptionPlan {
  STARTER
  PRO
  FOUNDING_PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  NONE
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
}

enum AccessLevel {
  BETA
  PAID
  EXPIRED
}

enum IntelligenceEngine {
  LISTING
  SELLER
  BUYER
  NEIGHBORHOOD
}

enum TaskStatus {
  OPEN
  DONE
}

enum TaskSource {
  PEOPLE_NOTE
  AUTOPILOT
  MANUAL
}

enum RelationshipType {
  CLIENT
  PARTNER
}

enum ContactStage {
  NEW
  WARM
  HOT
  PAST
}

enum ClientRole {
  BUYER
  SELLER
  BOTH
}

enum SmsDirection {
  OUTBOUND
  INBOUND
}

enum PhoneNumberStatus {
  ACTIVE
  DISABLED
  RELEASING
}

enum PhoneNumberProvider {
  TWILIO
}

enum PhoneCapability {
  SMS
  MMS
  VOICE
}

enum CallDirection {
  OUTBOUND
  INBOUND
}

enum CallStatus {
  QUEUED
  RINGING
  IN_PROGRESS
  COMPLETED
  BUSY
  FAILED
  NO_ANSWER
  CANCELED
}

enum MessageSource {
  MANUAL
  AUTOMATION
  ZORA
  SYSTEM
}

enum CommEventType {
  SMS_IN
  SMS_OUT
  CALL_IN
  CALL_OUT
  MISSED_CALL
  VOICEMAIL
  DELIVERY_UPDATE
}

enum ChatChannelType {
  BOARD
  ROOM
  DM
}

enum ChatMessageType {
  TEXT
  SYSTEM
}

enum ChatMessageStatus {
  SENT
  FAILED
}

enum ChatAttachmentType {
  IMAGE
  FILE
  LINK
}

enum ChatModerationAction {
  NONE
  FLAGGED
  HIDDEN
  REMOVED
}

// ---------------------------
// USER
// ---------------------------
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String?   @map("password_hash")
  image         String?
  brokerage     String?
  phone         String?
  phoneVerified DateTime?

  // Auth / app metadata
  role              UserRole  @default(USER)
  currentSessionKey String?   @db.VarChar(255)
  lastLoginAt       DateTime?
  openAITokensUsed  Int       @default(0)

  // Workspace default context (workspace-first billing + routing)
  defaultWorkspaceId String?
  defaultWorkspace   Workspace? @relation("UserDefaultWorkspace", fields: [defaultWorkspaceId], references: [id], onDelete: SetNull)

  // NextAuth relations
  accounts Account[]
  sessions Session[]

  // Workspace relations
  createdWorkspaces        Workspace[]       @relation("WorkspaceCreatedBy")
  workspaceMemberships     WorkspaceUser[]
  workspaceInvitesSent     WorkspaceInvite[] @relation("WorkspaceInviteInvitedBy")
  workspaceInvitesAccepted WorkspaceInvite[] @relation("WorkspaceInviteAcceptedBy")

  // Chat relations
  createdChatChannels  ChatChannel[] @relation("ChatChannelCreatedBy")
  archivedChatChannels ChatChannel[] @relation("ChatChannelArchivedBy")

  chatMessagesAuthored  ChatMessage[] @relation("ChatMessageAuthor")
  chatMessagesEdited    ChatMessage[] @relation("ChatMessageEditedBy")
  chatMessagesDeleted   ChatMessage[] @relation("ChatMessageDeletedBy")
  chatMessagesModerated ChatMessage[] @relation("ChatMessageModeratedBy")

  chatMentionsReceived ChatMention[] @relation("ChatMentionedUser")

  // Audit / assignment relations (workspace-scoped records)
  createdContacts Contact[] @relation("ContactCreatedBy")
  ownedContacts   Contact[] @relation("ContactOwner")

  createdListings Listing[] @relation("ListingCreatedBy")
  ownedListings   Listing[] @relation("ListingOwner")

  createdTasks  Task[] @relation("TaskCreatedBy")
  assignedTasks Task[] @relation("TaskAssignedTo")

  activityActor    Activity[]    @relation("ActivityActor")
  crmActivityActor CRMActivity[] @relation("CRMActivityActor")

  intelligenceOutputs IntelligenceOutput[] @relation("IntelligenceCreatedBy")
  crmRecords          CRMRecord[]          @relation("CRMRecordCreatedBy")
  automations         Automation[]         @relation("AutomationCreatedBy")

  createdAIArtifacts        AIArtifact[]        @relation("AIArtifactCreatedBy")
  createdAIContextSnapshots AIContextSnapshot[] @relation("AIContextSnapshotCreatedBy")

  smsMessages          SmsMessage[]      @relation("SmsMessageCreatedBy")
  smsSuppressions      SmsSuppression[]  @relation("SmsSuppressionCreatedBy")
  assignedPhoneNumbers UserPhoneNumber[] @relation("UserAssignedPhoneNumbers")
  calls                Call[]            @relation("UserCalls")
  smsMessagesAssigned  SmsMessage[]      @relation("UserSmsMessagesAssigned")
  conversations        Conversation[]    @relation("UserConversations")
  commEvents           CommEvent[]       @relation("UserCommEvents")

  passwordResetTokens     PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdPins        Pin[]               @relation("PinCreatedBy")
  createdContactPins ContactPin[]        @relation("ContactPinCreatedBy")
  createdListingPins ListingPin[]        @relation("ListingPinCreatedBy")
  ChatChannelMember  ChatChannelMember[]
  ChatReadState      ChatReadState[]
  ChatReaction       ChatReaction[]

  @@index([defaultWorkspaceId])
}

// ---------------------------
// WORKSPACES (TENANT / TEAM)
// ---------------------------
model Workspace {
  id   String @id @default(cuid())
  name String

  type            WorkspaceType @default(PERSONAL)
  createdByUserId String?
  createdByUser   User?         @relation("WorkspaceCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  // ---------------------------
  // BILLING (SOURCE OF TRUTH)
  // ---------------------------
  accessLevel        AccessLevel        @default(EXPIRED)
  plan               SubscriptionPlan   @default(STARTER)
  subscriptionStatus SubscriptionStatus @default(NONE)
  trialEndsAt        DateTime?
  currentPeriodEnd   DateTime?

  // Stripe identifiers (workspace-scoped)
  stripeCustomerId     String? @db.VarChar(255)
  stripeSubscriptionId String? @db.VarChar(255)

  // Optional: store price ids if you want to display/configure per-workspace pricing cleanly
  stripeBasePriceId String? @db.VarChar(255)
  stripeSeatPriceId String? @db.VarChar(255)

  // Seats
  seatLimit     Int @default(1)
  includedSeats Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members          WorkspaceUser[]
  defaultedByUsers User[]          @relation("UserDefaultWorkspace")

  // Tenant-owned relations
  contacts            Contact[]
  listings            Listing[]
  activities          Activity[]
  crmActivity         CRMActivity[]
  tasks               Task[]
  intelligenceOutputs IntelligenceOutput[]
  crmRecords          CRMRecord[]
  automations         Automation[]
  automationRuns      AutomationRun[]
  conversations       Conversation[]
  commEvents          CommEvent[]
  phoneNumbers        UserPhoneNumber[]
  calls               Call[]
  smsMessages         SmsMessage[]
  smsSuppressions     SmsSuppression[]
  pins                Pin[]
  contactPins         ContactPin[]
  listingPins         ListingPin[]
  invites             WorkspaceInvite[]
  chatChannels        ChatChannel[]
  chatMessages        ChatMessage[]
  chatReadStates      ChatReadState[]
  chatReactions       ChatReaction[]
  chatAttachments     ChatAttachment[]
  chatMentions        ChatMention[]
  chatMembers         ChatChannelMember[]
  aiArtifacts         AIArtifact[]
  aiJobs              AIJob[]
  aiContextSnapshots  AIContextSnapshot[]

  @@unique([stripeCustomerId])
  @@unique([stripeSubscriptionId])
  @@index([createdByUserId])
  @@index([plan, subscriptionStatus])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model WorkspaceUser {
  id String @id @default(cuid())

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  role WorkspaceRole @default(AGENT)

  createdAt DateTime  @default(now())
  joinedAt  DateTime  @default(now())
  removedAt DateTime?

  @@unique([workspaceId, userId])
  @@index([userId])
  @@index([workspaceId])
  @@index([workspaceId, removedAt])
}

model WorkspaceInvite {
  id String @id @default(cuid())

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  email    String
  emailKey String
  role     WorkspaceRole @default(AGENT)

  token      String                @unique
  status     WorkspaceInviteStatus @default(PENDING)
  expiresAt  DateTime
  acceptedAt DateTime?

  invitedByUserId String?
  invitedByUser   User?   @relation("WorkspaceInviteInvitedBy", fields: [invitedByUserId], references: [id], onDelete: SetNull)

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  acceptedByUserId String?
  acceptedByUser   User?     @relation("WorkspaceInviteAcceptedBy", fields: [acceptedByUserId], references: [id], onDelete: SetNull)
  revokedAt        DateTime?

  @@unique([workspaceId, emailKey])
  @@index([acceptedByUserId])
  @@index([workspaceId, status, revokedAt, expiresAt])
  @@index([email])
  @@index([emailKey])
  @@index([invitedByUserId])
}

// ---------------------------
// CHAT CHANNELS (WORKSPACE BOARD + ROOMS)
// ---------------------------
model ChatChannel {
  id String @id @default(cuid())

  // Tenant boundary
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  type ChatChannelType @default(BOARD)

  // Unique key per workspace ("board", "general", etc.)
  key  String @db.VarChar(48)
  name String

  // Optional: private channels later
  isPrivate Boolean @default(false)

  createdByUserId String?
  createdByUser   User?     @relation("ChatChannelCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  lastMessageAt   DateTime?

  // Light moderation/audit hooks at channel level
  archivedAt       DateTime?
  archivedByUserId String?
  archivedByUser   User?     @relation("ChatChannelArchivedBy", fields: [archivedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages    ChatMessage[]
  memberships ChatChannelMember[]
  readStates  ChatReadState[]

  @@unique([workspaceId, key])
  @@index([workspaceId, type])
  @@index([workspaceId, updatedAt])
  @@index([workspaceId, lastMessageAt])
  @@index([createdByUserId])
  @@index([archivedByUserId])
}

// ---------------------------
// CHAT MEMBERSHIP (optional now, enables private rooms later)
// ---------------------------
model ChatChannelMember {
  id String @id @default(cuid())

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  channelId String
  channel   ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // future-proof: role inside channel
  // role String?

  createdAt DateTime  @default(now())
  removedAt DateTime?

  @@unique([channelId, userId])
  @@index([workspaceId, userId])
  @@index([channelId, removedAt])
}

// ---------------------------
// CHAT MESSAGES (threads, edits, delivery status, moderation)
// ---------------------------
model ChatMessage {
  id String @id @default(cuid())

  // Tenant boundary
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  channelId String
  channel   ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  authorUserId String?
  authorUser   User?   @relation("ChatMessageAuthor", fields: [authorUserId], references: [id], onDelete: SetNull)

  type   ChatMessageType   @default(TEXT)
  status ChatMessageStatus @default(SENT)

  // Idempotency for retries
  clientNonce String? @db.VarChar(64)

  parentId String?
  parent   ChatMessage?  @relation("ChatThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies  ChatMessage[] @relation("ChatThread")

  body String

  editedAt       DateTime?
  editedByUserId String?
  editedByUser   User?     @relation("ChatMessageEditedBy", fields: [editedByUserId], references: [id], onDelete: SetNull)

  deletedAt       DateTime?
  deletedByUserId String?
  deletedByUser   User?     @relation("ChatMessageDeletedBy", fields: [deletedByUserId], references: [id], onDelete: SetNull)

  isVisible     Boolean @default(true)
  failureReason String?

  moderationAction  ChatModerationAction @default(NONE)
  moderatedAt       DateTime?
  moderatedByUserId String?
  moderatedByUser   User?                @relation("ChatMessageModeratedBy", fields: [moderatedByUserId], references: [id], onDelete: SetNull)
  moderationNotes   String?

  payload   Json?
  createdAt DateTime @default(now())

  reactions     ChatReaction[]
  attachments   ChatAttachment[]
  mentions      ChatMention[]
  ChatReadState ChatReadState[]

  @@unique([workspaceId, channelId, authorUserId, clientNonce])
  @@index([workspaceId, createdAt])
  @@index([channelId, createdAt])
  @@index([authorUserId, createdAt])
  @@index([parentId, createdAt])
  @@index([deletedAt])
  @@index([status])
  @@index([moderationAction, moderatedAt])
}

// ---------------------------
// PER-USER READ STATE (cursor-based)
// ---------------------------
model ChatReadState {
  id String @id @default(cuid())

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  channelId String
  channel   ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Cursor-based: what message have they read up through?
  lastReadMessageId String?
  lastReadMessage   ChatMessage? @relation(fields: [lastReadMessageId], references: [id], onDelete: SetNull)

  lastReadAt DateTime @default(now())

  @@unique([channelId, userId])
  @@index([workspaceId, userId])
  @@index([channelId, lastReadAt])
}

// ---------------------------
// REACTIONS
// ---------------------------
model ChatReaction {
  id String @id @default(cuid())

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  messageId String
  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  emoji String @db.VarChar(32)

  createdAt DateTime @default(now())

  @@unique([messageId, userId, emoji])
  @@index([workspaceId])
  @@index([messageId])
  @@index([userId])
}

// ---------------------------
// ATTACHMENTS (metadata only; store files in S3/Supabase later)
// ---------------------------
model ChatAttachment {
  id String @id @default(cuid())

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  messageId String
  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  type ChatAttachmentType

  url        String
  storageKey String?
  sha256     String?
  name       String?
  size       Int?
  mime       String?

  createdAt DateTime @default(now())

  @@index([workspaceId])
  @@index([messageId])
}

// ---------------------------
// MENTIONS (for notifications later)
// ---------------------------
model ChatMention {
  id String @id @default(cuid())

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  messageId String
  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  mentionedUserId String
  mentionedUser   User   @relation("ChatMentionedUser", fields: [mentionedUserId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([messageId, mentionedUserId])
  @@index([workspaceId, mentionedUserId, createdAt])
  @@index([messageId])
}

// ---------------------------
// CONTACTS
// ---------------------------
model Contact {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Audit / assignment (optional)
  createdByUserId String?
  createdByUser   User?   @relation("ContactCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  ownerUserId String?
  ownerUser   User?   @relation("ContactOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)

  firstName String?
  lastName  String?
  email     String?
  phone     String?

  smsConsentedAt   DateTime?
  smsConsentSource String?
  smsConsentText   String?
  smsOptedOutAt    DateTime?

  relationshipType RelationshipType @default(CLIENT)

  stage      ContactStage? @default(NEW)
  clientRole ClientRole?
  label      String?

  pins   ContactPin[]
  notes  String?
  source String?

  priceRange String?
  areas      String?
  timeline   String?

  partnerProfile PartnerProfile?

  contactNotes ContactNote[]
  tasks        Task[]

  listingsAsSeller Listing[]          @relation("SellerListings")
  buyerListings    ListingBuyerLink[]
  activities       Activity[]
  crmActivity      CRMActivity[]

  calls         Call[]
  conversations Conversation[]
  events        CommEvent[]

  intelligenceOutputs IntelligenceOutput[]
  aiArtifacts         AIArtifact[]

  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  SmsMessage SmsMessage[]

  @@index([workspaceId, relationshipType])
  @@index([workspaceId, relationshipType, stage])
  @@index([workspaceId, relationshipType, clientRole])
  @@index([workspaceId, ownerUserId])
  @@index([workspaceId, createdAt])
  @@index([workspaceId, phone]) // ✅ fast inbound From-number lookup
}

// Partner profile is a "detail table" for Contact when relationshipType=PARTNER
model PartnerProfile {
  id String @id @default(cuid())

  contactId String  @unique
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  businessName    String?
  partnerType     String?
  coverageMarkets String?
  feeComp         String?

  website    String?
  profileUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ---------------------------
// PINS (WORKSPACE-WIDE BANK)
// ---------------------------
model Pin {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Display label (keep casing for UI)
  name String

  // Normalized label (lowercase/trim) used for uniqueness + reuse
  nameKey String

  createdByUserId String?
  createdByUser   User?   @relation("PinCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contactPins ContactPin[]
  listingPins ListingPin[]

  // Case-insensitive uniqueness per workspace
  @@unique([workspaceId, nameKey])
  @@index([workspaceId])
  @@index([workspaceId, name])
  @@index([createdByUserId])
}

// ---------------------------
// PIN (ATTACHMENT)
// ---------------------------
model ContactPin {
  id String @id @default(cuid())

  // Tenant boundary (strict) — denormalized for fast + safe filtering
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  pinId String
  pin   Pin    @relation(fields: [pinId], references: [id], onDelete: Cascade)

  createdByUserId String?
  createdByUser   User?   @relation("ContactPinCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  // Prevent duplicate attachments
  @@unique([contactId, pinId])
  @@index([workspaceId, contactId, pinId])
  // Fast queries for filters/search
  @@index([workspaceId, contactId])
  @@index([workspaceId, pinId])
  @@index([createdByUserId])
}

model ListingPin {
  id String @id @default(cuid())

  // Tenant boundary (strict) — denormalized for fast + safe filtering
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  listingId String
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  pinId String
  pin   Pin    @relation(fields: [pinId], references: [id], onDelete: Cascade)

  createdByUserId String?
  createdByUser   User?   @relation("ListingPinCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  // Prevent duplicate attachments
  @@unique([listingId, pinId])
  @@index([workspaceId, listingId, pinId])
  // Fast queries for filters/search
  @@index([workspaceId, listingId])
  @@index([workspaceId, pinId])
  @@index([createdByUserId])
}

// ---------------------------
// LISTINGS
// ---------------------------
model Listing {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Audit / assignment (optional)
  createdByUserId String?
  createdByUser   User?   @relation("ListingCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  ownerUserId String?
  ownerUser   User?   @relation("ListingOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)

  // Primary seller contact for this listing
  seller          Contact? @relation("SellerListings", fields: [sellerContactId], references: [id])
  sellerContactId String?

  address     String
  mlsId       String?
  price       Int?
  status      String  @default("draft")
  description String?
  aiCopy      String?
  aiNotes     String?

  buyers ListingBuyerLink[]

  photos              ListingPhoto[]
  activities          Activity[]
  tasks               Task[]
  intelligenceOutputs IntelligenceOutput[]
  aiArtifacts         AIArtifact[]

  pins         ListingPin[]
  listingNotes ListingNote[]
  crmActivity  CRMActivity[]

  // ✅ Comms + automations context
  conversations Conversation[]
  commEvents    CommEvent[]
  smsMessages   SmsMessage[]
  calls         Call[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId, createdAt])
  @@index([workspaceId, ownerUserId])
}

// ---------------------------
// LISTING PHOTOS
// ---------------------------
model ListingPhoto {
  id        String  @id @default(cuid())
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  listingId String

  url       String
  isCover   Boolean @default(false)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())

  @@index([listingId])
}

// ---------------------------
// LISTING ↔ BUYER LINK
// ---------------------------
model ListingBuyerLink {
  id        String  @id @default(cuid())
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  listingId String

  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  contactId String

  role String?

  createdAt DateTime @default(now())

  @@unique([listingId, contactId])
  @@index([listingId])
  @@index([contactId])
}

// ---------------------------
// ACTIVITIES (SYSTEM EVENTS)
// ---------------------------
model Activity {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Who performed the action (optional; keep null for system events)
  actorUserId String?
  actorUser   User?   @relation("ActivityActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  type    String
  details String?

  createdAt DateTime @default(now())

  @@index([workspaceId, createdAt])
  @@index([workspaceId, contactId, createdAt])
  @@index([workspaceId, listingId, createdAt])
  @@index([contactId])
  @@index([listingId])
  @@index([actorUserId])
}

// ---------------------------
// CRM ACTIVITY (TIMELINE LOG)
// ---------------------------
model CRMActivity {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Who performed the action (optional)
  actorUserId String?
  actorUser   User?   @relation("CRMActivityActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  type    String
  summary String
  data    Json?

  createdAt DateTime @default(now())

  @@index([workspaceId, createdAt])
  @@index([workspaceId, contactId, createdAt])
  @@index([workspaceId, listingId, createdAt])
  @@index([actorUserId])
  @@index([listingId])
}

// ---------------------------
// INTELLIGENCE OUTPUTS (ENGINE RUNS)
// ---------------------------
model IntelligenceOutput {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Who ran/saved it (optional)
  createdByUserId String?
  createdByUser   User?   @relation("IntelligenceCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  engine IntelligenceEngine

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  aiArtifacts AIArtifact[] @relation("AIArtifactIntelligenceOutput")

  engineInput  Json?
  inputSummary String?
  payload      Json?
  preview      String?

  createdAt DateTime @default(now())

  @@index([workspaceId, createdAt])
  @@index([workspaceId, listingId, createdAt])
  @@index([workspaceId, contactId, createdAt])
  @@index([createdByUserId, createdAt])
}

// ---------------------------
// AI ARTIFACTS (PERSISTENT AI MEMORY + UI OBJECTS)
// ---------------------------
model AIArtifact {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Who generated it (optional)
  createdByUserId String?
  createdByUser   User?   @relation("AIArtifactCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  // Flexible targeting (optional)
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: Cascade)

  // What this artifact is (string-keyed to avoid enum migrations)
  // Examples:
  //   kind:  "next_best_actions", "daily_brief", "contact_summary", "listing_momentum"
  //   scope: "workspace" | "contact" | "listing"
  kind  String @db.VarChar(64)
  scope String @db.VarChar(24)

  // Versioning so you can iterate without breaking old reads
  version Int @default(1)

  // Content
  preview String?
  payload Json

  // Quality + lifecycle
  confidence Float?
  isActive   Boolean   @default(true) // allow replacement without deleting history
  expiresAt  DateTime?

  // Optional: tie back to a run (audit/debug)
  intelligenceOutputId String?
  intelligenceOutput   IntelligenceOutput? @relation("AIArtifactIntelligenceOutput", fields: [intelligenceOutputId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId, kind, scope, isActive, createdAt])
  @@index([workspaceId, kind, scope, isActive, updatedAt])
  @@index([workspaceId, contactId, kind, isActive, createdAt])
  @@index([workspaceId, listingId, kind, isActive, createdAt])
  @@index([createdByUserId, createdAt])
  @@index([intelligenceOutputId])
}

// ---------------------------
// AI JOBS (LIGHTWEIGHT QUEUE FOR TRIGGER-BASED FRESHNESS)
// ---------------------------
model AIJob {
  id String @id @default(cuid())

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // What to compute
  kind    String @db.VarChar(64) // "next_best_actions"
  scope   String @db.VarChar(24) // "workspace" | "contact" | "listing"
  version Int    @default(1)

  // Normalized target identity to guarantee uniqueness even when contactId/listingId is null
  // Examples:
  // - scope="workspace" => targetKey="workspace"
  // - scope="contact"   => targetKey="contact:<contactId>"
  // - scope="listing"   => targetKey="listing:<listingId>"
  targetKey String @db.VarChar(128)

  // Optional targeting
  contactId String?
  listingId String?

  // Scheduling / locking
  status   String   @default("queued") // queued|running|done|failed
  runAt    DateTime @default(now())
  attempts Int      @default(0)

  lockedAt DateTime?
  lockId   String?

  payload   Json?
  lastError String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Prevent job spam for same target (works reliably with Postgres NULL semantics)
  @@unique([workspaceId, kind, scope, version, targetKey])
  @@index([workspaceId, status, runAt])
  @@index([workspaceId, status, lockedAt])
  @@index([workspaceId, kind, scope, runAt])
  @@index([workspaceId, targetKey])
  @@index([workspaceId, contactId, kind, runAt])
  @@index([workspaceId, listingId, kind, runAt])
}

// ---------------------------
// AI CONTEXT SNAPSHOTS (OPTIONAL AUDIT/DEBUG; TTL-ABLE)
// ---------------------------
model AIContextSnapshot {
  id String @id @default(cuid())

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  createdByUserId String?
  createdByUser   User?   @relation("AIContextSnapshotCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  // Optional targeting
  contactId String?
  listingId String?

  // What this snapshot represents
  kind    String @db.VarChar(64)
  scope   String @db.VarChar(24)
  version Int    @default(1)

  // The assembled context payload (what the AI actually saw)
  payload Json

  // If you want automatic cleanup later
  expiresAt DateTime?
  createdAt DateTime  @default(now())

  @@index([workspaceId, kind, createdAt])
  @@index([workspaceId, expiresAt])
  @@index([createdByUserId, createdAt])
}

// ---------------------------
// NOTES (STRUCTURED)
// ---------------------------
model ContactNote {
  id        String  @id @default(cuid())
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  text       String
  reminderAt DateTime?

  createdAt DateTime @default(now())

  @@index([contactId, createdAt])
}

model ListingNote {
  id        String  @id @default(cuid())
  listingId String
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  text       String
  reminderAt DateTime?

  createdAt DateTime @default(now())

  @@index([listingId, createdAt])
}

// ---------------------------
// TASKS
// ---------------------------
model Task {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Audit / assignment
  createdByUserId String?
  createdByUser   User?   @relation("TaskCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  assignedToUserId String?
  assignedToUser   User?   @relation("TaskAssignedTo", fields: [assignedToUserId], references: [id], onDelete: SetNull)

  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: Cascade)

  title  String
  notes  String?
  dueAt  DateTime?
  status TaskStatus @default(OPEN)
  source TaskSource @default(MANUAL)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
  deletedAt   DateTime?

  @@index([workspaceId, status, dueAt])
  @@index([workspaceId, assignedToUserId, status, dueAt])
  @@index([workspaceId, contactId, status, dueAt])
  @@index([workspaceId, listingId, status, dueAt])
  @@index([workspaceId, deletedAt, status, dueAt])
  @@index([createdByUserId])
}

// ---------------------------
// NEXTAUTH
// ---------------------------
model Account {
  id     String @id @default(cuid())
  userId String

  type              String
  provider          String
  providerAccountId String

  refresh_token String?
  access_token  String?
  expires_at    Int?
  token_type    String?
  scope         String?
  id_token      String?
  session_state String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ---------------------------
// EMAIL VERIFICATION TOKENS
// ---------------------------
model EmailVerificationToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ---------------------------
// PASSWORD RESET TOKENS
// ---------------------------
model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ---------------------------
// CRM RAW RECORDS
// ---------------------------
model CRMRecord {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Who created/ingested it (optional)
  createdByUserId String?
  createdByUser   User?   @relation("CRMRecordCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  raw       String
  processed String
  type      String
  createdAt DateTime @default(now())

  @@index([workspaceId, createdAt])
  @@index([workspaceId, type, createdAt])
  @@index([createdByUserId, createdAt])
}

// ---------------------------
// AUTOMATION (workflow definition)
// ---------------------------
model Automation {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Who created it (optional)
  createdByUserId String?
  createdByUser   User?   @relation("AutomationCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  name        String
  description String?
  status      String  @default("draft")

  trigger         String
  triggerConfig   Json?
  entryConditions Json?
  exitConditions  Json?
  schedule        Json?

  folder String?

  active   Boolean @default(true)
  reEnroll Boolean @default(true)
  timezone String?

  lastTriggeredAt DateTime?
  lastExecutedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  steps AutomationStepGroup?
  runs  AutomationRun[]

  @@index([workspaceId])
  @@index([workspaceId, active])
  @@index([status])
  @@index([createdByUserId])
}

model AutomationStepGroup {
  id           String @id @default(cuid())
  automationId String @unique
  steps        Json

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
}

model AutomationRun {
  id String @id @default(cuid())

  automationId String
  automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  contactId String?
  listingId String?

  smsMessages SmsMessage[]
  calls       Call[]
  commEvents  CommEvent[]

  trigger        String?
  triggerPayload Json?

  status  String
  message String?

  executedAt DateTime @default(now())
  lockId     String?

  steps AutomationRunStep[]

  @@index([workspaceId, executedAt])
  @@index([workspaceId, automationId, executedAt]) 
  @@index([automationId])
  @@index([contactId])
  @@index([listingId])
  @@index([status])
}

model AutomationRunStep {
  id    String @id @default(cuid())
  runId String

  stepId     String?
  stepIndex  Int
  stepType   String
  status     String
  message    String?
  executedAt DateTime @default(now())
  payload    Json?

  run AutomationRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@index([stepType])
  @@index([status])
}

// ---------------------------
// Phone
// ---------------------------
model Conversation {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Owner agent of this conversation (because the Avillo number is user-owned)
  assignedToUserId String
  assignedToUser   User   @relation("UserConversations", fields: [assignedToUserId], references: [id], onDelete: Cascade)

  // The Avillo number used for this thread
  phoneNumberId String
  phoneNumber   UserPhoneNumber @relation("PhoneNumberConversations", fields: [phoneNumberId], references: [id], onDelete: Restrict)

  // Optional CRM linkage
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  // Optional listing context (lets automations/zora reason inside listing scope)
  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  // Deterministic key so inbound webhooks can upsert the same thread reliably:
  // Example: "pn:<phoneNumberId>:contact:<contactId>" or "pn:<phoneNumberId>:lead:<fromE164>"
  threadKey String @db.VarChar(160)

  // Display + automation helpers
  displayName    String?
  lastMessageAt  DateTime?
  lastInboundAt  DateTime?
  lastOutboundAt DateTime?

  // Zora memory hooks (optional but super useful)
  zoraSummary String?
  zoraState   Json?
  lastZoraAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  smsMessages SmsMessage[]
  calls       Call[]
  events      CommEvent[]

  @@unique([workspaceId, threadKey])
  @@index([workspaceId, assignedToUserId, lastMessageAt])
  @@index([workspaceId, contactId, lastMessageAt])
  @@index([workspaceId, listingId, lastMessageAt])
  @@index([workspaceId, phoneNumberId, lastMessageAt])
}

model CommEvent {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  type   CommEventType
  source MessageSource @default(SYSTEM)

  // Core routing context
  assignedToUserId String?
  assignedToUser   User?   @relation("UserCommEvents", fields: [assignedToUserId], references: [id], onDelete: SetNull)

  phoneNumberId String?
  phoneNumber   UserPhoneNumber? @relation("PhoneNumberCommEvents", fields: [phoneNumberId], references: [id], onDelete: SetNull)

  conversationId String?
  conversation   Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  // Event linkage
  smsMessageId String?
  smsMessage   SmsMessage? @relation(fields: [smsMessageId], references: [id], onDelete: Cascade)

  callId String?
  call   Call?   @relation(fields: [callId], references: [id], onDelete: Cascade)

  // Optional: link to the automation run that generated the event
  automationRunId String?
  automationRun   AutomationRun? @relation(fields: [automationRunId], references: [id], onDelete: SetNull)

  occurredAt DateTime @default(now())
  payload    Json?

  createdAt DateTime @default(now())

  @@index([workspaceId, occurredAt])
  @@index([workspaceId, assignedToUserId, occurredAt])
  @@index([workspaceId, conversationId, occurredAt])
  @@index([workspaceId, contactId, occurredAt])
  @@index([workspaceId, listingId, occurredAt])
  @@index([workspaceId, phoneNumberId, occurredAt])
  // Link lookups (not unique; safe with nulls)
  @@index([smsMessageId])
  @@index([callId])
  @@index([automationRunId])
}

model UserPhoneNumber {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // ✅ Assigned per user
  assignedToUserId String
  assignedToUser   User   @relation("UserAssignedPhoneNumbers", fields: [assignedToUserId], references: [id], onDelete: Cascade)

  provider PhoneNumberProvider @default(TWILIO)
  status   PhoneNumberStatus   @default(ACTIVE)

  // E.164 format (e.g. +15035551212)
  e164 String @db.VarChar(32)

  twilioIncomingPhoneNumberSid String? @db.VarChar(64)
  twilioMessagingServiceSid    String? @db.VarChar(64)

  capabilities PhoneCapability[] @default([SMS, VOICE])
  label        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  smsMessages   SmsMessage[]   @relation("SmsMessagePhoneNumber")
  calls         Call[]         @relation("CallPhoneNumber")
  conversations Conversation[] @relation("PhoneNumberConversations")
  events        CommEvent[]    @relation("PhoneNumberCommEvents")

  @@unique([e164])
  @@index([workspaceId, assignedToUserId, status])
  @@index([workspaceId, e164])
  @@index([twilioIncomingPhoneNumberSid])
}

model Call {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Which Avillo number was used/received the call
  phoneNumberId String
  phoneNumber   UserPhoneNumber @relation("CallPhoneNumber", fields: [phoneNumberId], references: [id], onDelete: Restrict)

  // Agent owner (denormalized, critical for automations)
  assignedToUserId String
  assignedToUser   User   @relation("UserCalls", fields: [assignedToUserId], references: [id], onDelete: Cascade)

  // ✅ Automations/Zora attribution + loop prevention
  source MessageSource @default(SYSTEM)

  // Threading
  conversationId String?
  conversation   Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Optional CRM linkage
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  // Optional listing context
  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  direction CallDirection
  status    CallStatus    @default(QUEUED)

  fromNumber String @db.VarChar(32)
  toNumber   String @db.VarChar(32)

  // Twilio Call SID (CA...)
  twilioCallSid String @db.VarChar(64)

  durationSec Int?
  startedAt   DateTime?
  endedAt     DateTime?

  recordingUrl String?
  recordingSid String? @db.VarChar(64)

  error String?

  // Link back to the run that generated it
  automationRunId String?
  automationRun   AutomationRun? @relation(fields: [automationRunId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Event stream linkage
  events CommEvent[]

  @@unique([twilioCallSid])
  @@index([workspaceId, createdAt])
  @@index([workspaceId, assignedToUserId, createdAt])
  @@index([workspaceId, phoneNumberId, createdAt])
  @@index([workspaceId, conversationId, createdAt])
  @@index([workspaceId, contactId, createdAt])
  @@index([workspaceId, listingId, createdAt])
  @@index([automationRunId])
}

// ---------------------------
// SMS
// ---------------------------
model SmsSuppression {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  createdByUserId String?
  createdByUser   User?   @relation("SmsSuppressionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  phone  String
  reason String @default("STOP")

  createdAt DateTime @default(now())

  @@unique([workspaceId, phone])
  @@index([workspaceId, phone])
  @@index([createdByUserId])
}

model SmsMessage {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  createdByUserId String?
  createdByUser   User?   @relation("SmsMessageCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  // ✅ Automations/Zora attribution + loop prevention
  source MessageSource @default(MANUAL)

  // Which Avillo number was used/received this message
  phoneNumberId String?
  phoneNumber   UserPhoneNumber? @relation("SmsMessagePhoneNumber", fields: [phoneNumberId], references: [id], onDelete: SetNull)

  // Deterministic owner (set on inbound by To-number lookup)
  assignedToUserId String?
  assignedToUser   User?   @relation("UserSmsMessagesAssigned", fields: [assignedToUserId], references: [id], onDelete: SetNull)

  // Threading (the key to next-level automations)
  conversationId String?
  conversation   Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // CRM context
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  // Optional listing context
  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  direction  SmsDirection
  fromNumber String
  toNumber   String
  body       String

  // Twilio Message SID (SM...)
  twilioSid String? @unique

  status String?
  error  String?

  // Link back to the run that generated it
  automationRunId String?
  automationRun   AutomationRun? @relation(fields: [automationRunId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  // Event stream linkage
  events CommEvent[]

  @@index([workspaceId, createdAt])
  @@index([workspaceId, toNumber])
  @@index([workspaceId, fromNumber])
  @@index([workspaceId, phoneNumberId, createdAt])
  @@index([workspaceId, assignedToUserId, createdAt])
  @@index([workspaceId, conversationId, createdAt])
  @@index([workspaceId, contactId, createdAt])
  @@index([workspaceId, listingId, createdAt])
  @@index([automationRunId])
  @@index([createdByUserId])
}
