// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------
// ENUMS
// ---------------------------
enum UserRole {
  USER
  ADMIN
}

// Plans you sell (Starter / Pro / Founding Pro)
enum SubscriptionPlan {
  STARTER
  PRO
  FOUNDING_PRO
}

// Stripe lifecycle status (trialing/active/etc.)
enum SubscriptionStatus {
  NONE
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
}

enum AccessLevel {
  BETA
  PAID
  EXPIRED
}

enum IntelligenceEngine {
  LISTING
  SELLER
  BUYER
  NEIGHBORHOOD
}

enum TaskStatus {
  OPEN
  DONE
}

enum TaskSource {
  PEOPLE_NOTE
  AUTOPILOT
  MANUAL
}

// ---------------------------
// USER
// ---------------------------
model User {
  id               String   @id @default(cuid())
  name             String?
  email            String   @unique
  emailVerified    DateTime?
  passwordHash     String?  @map("password_hash")
  image            String?
  brokerage        String?

  // Auth / app metadata
  role             UserRole @default(USER)
  currentSessionKey String? @db.VarChar(255)
  lastLoginAt       DateTime?
  openAITokensUsed  Int      @default(0)

  // Billing / subscription state (NEW)
  accessLevel         AccessLevel        @default(EXPIRED)
  plan                 SubscriptionPlan   @default(STARTER)
  subscriptionStatus   SubscriptionStatus @default(NONE)
  trialEndsAt          DateTime?
  currentPeriodEnd     DateTime?

  stripeCustomerId     String? @db.VarChar(255)
  stripeSubscriptionId String? @db.VarChar(255)
  stripePriceId        String? @db.VarChar(255)

  // Auth relations
  accounts Account[]
  sessions Session[]

  // App relations
  contacts                 Contact[]
  listings                 Listing[]
  activities               Activity[]
  CRMRecord                CRMRecord[]
  crmActivity              CRMActivity[]
  passwordResetTokens      PasswordResetToken[]
  emailVerificationTokens  EmailVerificationToken[]
  tasks                    Task[]
  intelligenceOutputs      IntelligenceOutput[] // <-- NEW

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ---------------------------
// CONTACTS
// ---------------------------
model Contact {
  id        String @id @default(cuid())
  user      User   @relation(fields: [userId], references: [id])
  userId    String

  firstName String?
  lastName  String?
  email     String?
  phone     String?

  smsConsentedAt   DateTime?
  smsConsentSource String?
  smsConsentText   String?
  smsOptedOutAt    DateTime?

  stage     String  @default("new") // new → warm → hot → past
  tags      String[] @default([])

  // Legacy free-form notes field (kept for backwards compatibility)
  notes     String?
  source    String? // Zillow, Open House, Referral, Social, etc.

  // Avillo CRM — pipeline + profile fields
  label     String? // e.g. "potential buy"
  type      String? // "Buyer" | "Seller" | "Past / sphere"
  priceRange String?
  areas     String?
  timeline  String?

  // Structured note entries per contact
  contactNotes ContactNote[]
  tasks        Task[]

  // Relationships to listings
  listingsAsSeller Listing[]       @relation("SellerListings")
  buyerListings    ListingBuyerLink[]
  activities       Activity[]
  crmActivity      CRMActivity[]

  intelligenceOutputs IntelligenceOutput[] // <-- NEW

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ---------------------------
// LISTINGS
// ---------------------------
model Listing {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String

  // Primary seller contact for this listing
  seller          Contact? @relation("SellerListings", fields: [sellerContactId], references: [id])
  sellerContactId String?

  address     String
  mlsId       String?
  price       Int?
  status      String @default("draft")
  description String?
  aiCopy      String?
  aiNotes     String?

  // Tagged buyers (many-to-many via join table)
  buyers ListingBuyerLink[]

  // Listing photos (1-many)
  photos             ListingPhoto[]
  activities         Activity[]
  tasks              Task[]
  intelligenceOutputs IntelligenceOutput[] // <-- NEW

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ---------------------------
// LISTING PHOTOS
// ---------------------------
model ListingPhoto {
  id        String  @id @default(cuid())
  listing   Listing @relation(fields: [listingId], references: [id])
  listingId String

  url       String
  isCover   Boolean @default(false)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
}

// ---------------------------
// LISTING ↔ BUYER LINK
// ---------------------------
model ListingBuyerLink {
  id        String  @id @default(cuid())
  listing   Listing @relation(fields: [listingId], references: [id])
  listingId String

  contact   Contact @relation(fields: [contactId], references: [id])
  contactId String

  role      String? // "primary", "backup", "interested", etc.

  createdAt DateTime @default(now())

  @@unique([listingId, contactId])
}

// ---------------------------
// ACTIVITIES (SYSTEM EVENTS)
// ---------------------------
model Activity {
  id        String  @id @default(cuid())
  user      User    @relation(fields: [userId], references: [id])
  userId    String

  contact   Contact? @relation(fields: [contactId], references: [id])
  contactId String?

  listing   Listing? @relation(fields: [listingId], references: [id])
  listingId String?

  type      String // "call", "email", "note", "showing", "task"
  details   String?

  createdAt DateTime @default(now())
}

// ---------------------------
// CRM ACTIVITY (TIMELINE LOG)
// Billion-dollar SaaS standard
// ---------------------------
model CRMActivity {
  id        String  @id @default(cuid())
  userId    String
  contactId String?

  type      String // "created", "updated", "stage_change", "note", "call", "ai_generated"
  summary   String
  data      Json?

  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  contact Contact? @relation(fields: [contactId], references: [id])
}

// ---------------------------
// INTELLIGENCE OUTPUTS (ENGINE RUNS)
// ---------------------------
model IntelligenceOutput {
  id String @id @default(cuid())

  // owner
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // which engine
  engine IntelligenceEngine

  // optional context
  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id])

  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id])

  // request + response blobs
  engineInput  Json?
  inputSummary String? // short line of what the user typed / selected
  payload      Json?   // full pack
  preview      String? // short preview of output

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([userId, listingId, createdAt])
  @@index([userId, contactId, createdAt])
}

// ---------------------------
// CONTACT NOTES (STRUCTURED)
// ---------------------------
model ContactNote {
  id        String  @id @default(cuid())
  contact   Contact @relation(fields: [contactId], references: [id])
  contactId String

  text      String
  reminderAt DateTime?

  createdAt DateTime @default(now())
}

// ---------------------------
// TASKS
// ---------------------------
model Task {
  id        String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: Cascade)

  title     String
  notes     String?
  dueAt     DateTime?
  status    TaskStatus @default(OPEN)
  source    TaskSource @default(MANUAL)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?
  deletedAt DateTime?

  @@index([userId, status, dueAt])
  @@index([userId, contactId, status, dueAt])
  @@index([userId, listingId, status, dueAt])
  @@index([userId, deletedAt, status, dueAt])
}

// ---------------------------
// NEXTAUTH
// ---------------------------
model Account {
  id                String @id @default(cuid())
  userId            String

  type              String
  provider          String
  providerAccountId String

  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id])

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id])
}

model VerificationToken {
  identifier String
  token      String @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ---------------------------
// EMAIL VERIFICATION TOKENS
// ---------------------------
model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

// ---------------------------
// PASSWORD RESET TOKENS
// ---------------------------
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

// ---------------------------
// CRM RAW RECORDS
// ---------------------------
model CRMRecord {
  id        String @id @default(cuid())
  userId    String
  raw       String
  processed String
  type      String // listing | buyer | seller
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

// ---------------------------
// AUTOMATION (workflow definition)
// ---------------------------
model Automation {
  id          String @id @default(cuid())
  userId      String
  name        String
  description String?
  status      String @default("draft") // draft | active | paused | archived

  trigger       String
  triggerConfig Json?
  entryConditions Json?
  exitConditions  Json?
  schedule        Json?

  folder String?

  active   Boolean @default(true)
  reEnroll Boolean @default(true)
  timezone String?

  lastTriggeredAt DateTime?
  lastExecutedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  steps AutomationStepGroup?
  runs  AutomationRun[]

  @@index([userId])
  @@index([userId, active])
  @@index([status])
}

model AutomationStepGroup {
  id           String @id @default(cuid())
  automationId String @unique
  steps        Json

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
}

model AutomationRun {
  id           String @id @default(cuid())
  automationId String

  contactId String?
  listingId String?

  trigger        String?
  triggerPayload Json?

  status   String
  message  String?

  executedAt DateTime @default(now())
  lockId    String?

  steps AutomationRunStep[]

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId])
  @@index([contactId])
  @@index([listingId])
  @@index([status])
}

model AutomationRunStep {
  id       String @id @default(cuid())
  runId    String

  stepId   String?
  stepIndex Int
  stepType  String
  status    String
  message   String?
  executedAt DateTime @default(now())
  payload    Json?

  run AutomationRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@index([stepType])
  @@index([status])
}

enum SmsDirection {
  OUTBOUND
  INBOUND
}

model SmsSuppression {
  id        String   @id @default(cuid())
  userId    String
  phone     String   // E.164
  reason    String   @default("STOP")
  createdAt DateTime @default(now())

  @@unique([userId, phone])
  @@index([userId, phone])
}

model SmsMessage {
  id          String       @id @default(cuid())
  userId      String
  contactId   String?
  direction   SmsDirection
  fromNumber  String
  toNumber    String
  body        String
  twilioSid   String?
  status      String?
  error       String?
  createdAt   DateTime     @default(now())

  @@index([userId, createdAt])
  @@index([userId, toNumber])
  @@index([contactId])
}