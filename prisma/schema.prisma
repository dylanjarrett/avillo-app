// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ---------------------------
// ENUMS
// ---------------------------

// Platform-wide role (Avillo staff/admin)
enum UserRole {
  USER
  ADMIN
}

// Workspace membership role (teams)
enum WorkspaceRole {
  OWNER
  ADMIN
  AGENT
}

enum WorkspaceInviteStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum SubscriptionPlan {
  STARTER
  PRO
  FOUNDING_PRO
}

enum SubscriptionStatus {
  NONE
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
}

enum AccessLevel {
  BETA
  PAID
  EXPIRED
}

enum IntelligenceEngine {
  LISTING
  SELLER
  BUYER
  NEIGHBORHOOD
}

enum TaskStatus {
  OPEN
  DONE
}

enum TaskSource {
  PEOPLE_NOTE
  AUTOPILOT
  MANUAL
}

enum RelationshipType {
  CLIENT
  PARTNER
}

enum ContactStage {
  NEW
  WARM
  HOT
  PAST
}

enum ClientRole {
  BUYER
  SELLER
  BOTH
}

enum SmsDirection {
  OUTBOUND
  INBOUND
}

// ---------------------------
// USER
// ---------------------------
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String?   @map("password_hash")
  image         String?
  brokerage     String?
  phone         String?
  phoneVerified DateTime?

  // Auth / app metadata
  role              UserRole  @default(USER)
  currentSessionKey String?   @db.VarChar(255)
  lastLoginAt       DateTime?
  openAITokensUsed  Int       @default(0)

  // Billing / subscription state
  accessLevel        AccessLevel        @default(EXPIRED)
  plan               SubscriptionPlan   @default(STARTER)
  subscriptionStatus SubscriptionStatus @default(NONE)
  trialEndsAt        DateTime?
  currentPeriodEnd   DateTime?

  stripeCustomerId     String? @db.VarChar(255)
  stripeSubscriptionId String? @db.VarChar(255)
  stripePriceId        String? @db.VarChar(255)

  // NextAuth relations
  accounts Account[]
  sessions Session[]

  // Workspace relations
  createdWorkspaces        Workspace[]       @relation("WorkspaceCreatedBy")
  workspaceMemberships     WorkspaceUser[]
  workspaceInvitesSent     WorkspaceInvite[] @relation("WorkspaceInviteInvitedBy")
  workspaceInvitesAccepted WorkspaceInvite[] @relation("WorkspaceInviteAcceptedBy")

  // Audit / assignment relations (workspace-scoped records)
  createdContacts Contact[] @relation("ContactCreatedBy")
  ownedContacts   Contact[] @relation("ContactOwner")

  createdListings Listing[] @relation("ListingCreatedBy")
  ownedListings   Listing[] @relation("ListingOwner")

  createdTasks  Task[] @relation("TaskCreatedBy")
  assignedTasks Task[] @relation("TaskAssignedTo")

  activityActor    Activity[]    @relation("ActivityActor")
  crmActivityActor CRMActivity[] @relation("CRMActivityActor")

  intelligenceOutputs IntelligenceOutput[] @relation("IntelligenceCreatedBy")
  crmRecords          CRMRecord[]          @relation("CRMRecordCreatedBy")
  automations         Automation[]         @relation("AutomationCreatedBy")

  smsMessages     SmsMessage[]     @relation("SmsMessageCreatedBy")
  smsSuppressions SmsSuppression[] @relation("SmsSuppressionCreatedBy")

  passwordResetTokens     PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdPins        Pin[]        @relation("PinCreatedBy")
  createdContactPins ContactPin[] @relation("ContactPinCreatedBy")
}

// ---------------------------
// WORKSPACES (TENANT / TEAM)
// ---------------------------
model Workspace {
  id   String @id @default(cuid())
  name String

  createdByUserId String?
  createdByUser   User?   @relation("WorkspaceCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members WorkspaceUser[]

  // Tenant-owned relations
  contacts            Contact[]
  listings            Listing[]
  activities          Activity[]
  crmActivity         CRMActivity[]
  tasks               Task[]
  intelligenceOutputs IntelligenceOutput[]
  crmRecords          CRMRecord[]
  automations         Automation[]
  automationRuns      AutomationRun[]
  smsMessages         SmsMessage[]
  smsSuppressions     SmsSuppression[]
  pins                Pin[]
  contactPins         ContactPin[]
  invites             WorkspaceInvite[]

  @@index([createdByUserId])
}

model WorkspaceUser {
  id String @id @default(cuid())

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  role WorkspaceRole @default(AGENT)

  createdAt DateTime  @default(now())
  joinedAt  DateTime  @default(now())
  removedAt DateTime?

  @@unique([workspaceId, userId])
  @@index([userId])
  @@index([workspaceId])
  @@index([workspaceId, removedAt])
}

model WorkspaceInvite {
  id String @id @default(cuid())

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  email    String
  emailKey String
  role     WorkspaceRole @default(AGENT)

  token      String                @unique
  status     WorkspaceInviteStatus @default(PENDING)
  expiresAt  DateTime
  acceptedAt DateTime?

  invitedByUserId String?
  invitedByUser   User?   @relation("WorkspaceInviteInvitedBy", fields: [invitedByUserId], references: [id], onDelete: SetNull)

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  acceptedByUserId String?
  acceptedByUser   User?     @relation("WorkspaceInviteAcceptedBy", fields: [acceptedByUserId], references: [id], onDelete: SetNull)
  revokedAt        DateTime?

  @@unique([workspaceId, emailKey])
  @@index([acceptedByUserId])
  @@index([workspaceId, status, expiresAt])
  @@index([email])
  @@index([emailKey])
  @@index([invitedByUserId])
}

// ---------------------------
// CONTACTS
// ---------------------------
model Contact {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Audit / assignment (optional)
  createdByUserId String?
  createdByUser   User?   @relation("ContactCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  ownerUserId String?
  ownerUser   User?   @relation("ContactOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)

  firstName String?
  lastName  String?
  email     String?
  phone     String?

  smsConsentedAt   DateTime?
  smsConsentSource String?
  smsConsentText   String?
  smsOptedOutAt    DateTime?

  relationshipType RelationshipType @default(CLIENT)

  // Pipeline + role (CLIENT only; keep null for PARTNER)
  stage      ContactStage? @default(NEW)
  clientRole ClientRole?
  label      String?

  // Common attributes
  pins   ContactPin[]
  notes  String?
  source String?

  // Client profile fields
  priceRange String?
  areas      String?
  timeline   String?

  // Partner profile
  partnerProfile PartnerProfile?

  // Structured note entries per contact
  contactNotes ContactNote[]
  tasks        Task[]

  // Relationships to listings
  listingsAsSeller Listing[]          @relation("SellerListings")
  buyerListings    ListingBuyerLink[]
  activities       Activity[]
  crmActivity      CRMActivity[]

  intelligenceOutputs IntelligenceOutput[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId, relationshipType])
  @@index([workspaceId, relationshipType, stage])
  @@index([workspaceId, relationshipType, clientRole])
  @@index([workspaceId, ownerUserId])
  @@index([workspaceId, createdAt])
}

// Partner profile is a "detail table" for Contact when relationshipType=PARTNER
model PartnerProfile {
  id String @id @default(cuid())

  contactId String  @unique
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  businessName    String?
  partnerType     String?
  coverageMarkets String?
  feeComp         String?

  website    String?
  profileUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ---------------------------
// PINS (WORKSPACE-WIDE BANK)
// ---------------------------
model Pin {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Display label (keep casing for UI)
  name String

  // Normalized label (lowercase/trim) used for uniqueness + reuse
  nameKey String

  createdByUserId String?
  createdByUser   User?   @relation("PinCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contactPins ContactPin[]

  // Case-insensitive uniqueness per workspace
  @@unique([workspaceId, nameKey])
  @@index([workspaceId])
  @@index([workspaceId, name])
  @@index([createdByUserId])
}

// ---------------------------
// CONTACT ↔ PIN (ATTACHMENT)
// ---------------------------
model ContactPin {
  id String @id @default(cuid())

  // Tenant boundary (strict) — denormalized for fast + safe filtering
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  pinId String
  pin   Pin    @relation(fields: [pinId], references: [id], onDelete: Cascade)

  createdByUserId String?
  createdByUser   User?   @relation("ContactPinCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  // Prevent duplicate attachments
  @@unique([contactId, pinId])
  @@index([workspaceId, contactId, pinId])
  // Fast queries for filters/search
  @@index([workspaceId, contactId])
  @@index([workspaceId, pinId])
  @@index([createdByUserId])
}

// ---------------------------
// LISTINGS
// ---------------------------
model Listing {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Audit / assignment (optional)
  createdByUserId String?
  createdByUser   User?   @relation("ListingCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  ownerUserId String?
  ownerUser   User?   @relation("ListingOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)

  // Primary seller contact for this listing
  seller          Contact? @relation("SellerListings", fields: [sellerContactId], references: [id])
  sellerContactId String?

  address     String
  mlsId       String?
  price       Int?
  status      String  @default("draft")
  description String?
  aiCopy      String?
  aiNotes     String?

  buyers ListingBuyerLink[]

  photos              ListingPhoto[]
  activities          Activity[]
  tasks               Task[]
  intelligenceOutputs IntelligenceOutput[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId, createdAt])
  @@index([workspaceId, ownerUserId])
}

// ---------------------------
// LISTING PHOTOS
// ---------------------------
model ListingPhoto {
  id        String  @id @default(cuid())
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  listingId String

  url       String
  isCover   Boolean @default(false)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())

  @@index([listingId])
}

// ---------------------------
// LISTING ↔ BUYER LINK
// ---------------------------
model ListingBuyerLink {
  id        String  @id @default(cuid())
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  listingId String

  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  contactId String

  role String?

  createdAt DateTime @default(now())

  @@unique([listingId, contactId])
  @@index([listingId])
  @@index([contactId])
}

// ---------------------------
// ACTIVITIES (SYSTEM EVENTS)
// ---------------------------
model Activity {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Who performed the action (optional; keep null for system events)
  actorUserId String?
  actorUser   User?   @relation("ActivityActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  type    String
  details String?

  createdAt DateTime @default(now())

  @@index([workspaceId, createdAt])
  @@index([workspaceId, contactId, createdAt])
  @@index([workspaceId, listingId, createdAt])
  @@index([contactId])
  @@index([listingId])
  @@index([actorUserId])
}

// ---------------------------
// CRM ACTIVITY (TIMELINE LOG)
// ---------------------------
model CRMActivity {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Who performed the action (optional)
  actorUserId String?
  actorUser   User?   @relation("CRMActivityActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  type    String
  summary String
  data    Json?

  createdAt DateTime @default(now())

  @@index([workspaceId, createdAt])
  @@index([workspaceId, contactId, createdAt])
  @@index([actorUserId])
}

// ---------------------------
// INTELLIGENCE OUTPUTS (ENGINE RUNS)
// ---------------------------
model IntelligenceOutput {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Who ran/saved it (optional)
  createdByUserId String?
  createdByUser   User?   @relation("IntelligenceCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  engine IntelligenceEngine

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  engineInput  Json?
  inputSummary String?
  payload      Json?
  preview      String?

  createdAt DateTime @default(now())

  @@index([workspaceId, createdAt])
  @@index([workspaceId, listingId, createdAt])
  @@index([workspaceId, contactId, createdAt])
  @@index([createdByUserId, createdAt])
}

// ---------------------------
// CONTACT NOTES (STRUCTURED)
// ---------------------------
model ContactNote {
  id        String  @id @default(cuid())
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  text       String
  reminderAt DateTime?

  createdAt DateTime @default(now())

  @@index([contactId, createdAt])
}

// ---------------------------
// TASKS
// ---------------------------
model Task {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Audit / assignment
  createdByUserId String?
  createdByUser   User?   @relation("TaskCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  assignedToUserId String?
  assignedToUser   User?   @relation("TaskAssignedTo", fields: [assignedToUserId], references: [id], onDelete: SetNull)

  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: Cascade)

  title  String
  notes  String?
  dueAt  DateTime?
  status TaskStatus @default(OPEN)
  source TaskSource @default(MANUAL)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
  deletedAt   DateTime?

  @@index([workspaceId, status, dueAt])
  @@index([workspaceId, assignedToUserId, status, dueAt])
  @@index([workspaceId, contactId, status, dueAt])
  @@index([workspaceId, listingId, status, dueAt])
  @@index([workspaceId, deletedAt, status, dueAt])
  @@index([createdByUserId])
}

// ---------------------------
// NEXTAUTH
// ---------------------------
model Account {
  id     String @id @default(cuid())
  userId String

  type              String
  provider          String
  providerAccountId String

  refresh_token String?
  access_token  String?
  expires_at    Int?
  token_type    String?
  scope         String?
  id_token      String?
  session_state String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ---------------------------
// EMAIL VERIFICATION TOKENS
// ---------------------------
model EmailVerificationToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ---------------------------
// PASSWORD RESET TOKENS
// ---------------------------
model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ---------------------------
// CRM RAW RECORDS
// ---------------------------
model CRMRecord {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Who created/ingested it (optional)
  createdByUserId String?
  createdByUser   User?   @relation("CRMRecordCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  raw       String
  processed String
  type      String
  createdAt DateTime @default(now())

  @@index([workspaceId, createdAt])
  @@index([workspaceId, type, createdAt])
  @@index([createdByUserId, createdAt])
}

// ---------------------------
// AUTOMATION (workflow definition)
// ---------------------------
model Automation {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Who created it (optional)
  createdByUserId String?
  createdByUser   User?   @relation("AutomationCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  name        String
  description String?
  status      String  @default("draft")

  trigger         String
  triggerConfig   Json?
  entryConditions Json?
  exitConditions  Json?
  schedule        Json?

  folder String?

  active   Boolean @default(true)
  reEnroll Boolean @default(true)
  timezone String?

  lastTriggeredAt DateTime?
  lastExecutedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  steps AutomationStepGroup?
  runs  AutomationRun[]

  @@index([workspaceId])
  @@index([workspaceId, active])
  @@index([status])
  @@index([createdByUserId])
}

model AutomationStepGroup {
  id           String @id @default(cuid())
  automationId String @unique
  steps        Json

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
}

model AutomationRun {
  id String @id @default(cuid())

  automationId String
  automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  // Tenant boundary (strict) — denormalized for safe querying
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  contactId String?
  listingId String?

  trigger        String?
  triggerPayload Json?

  status  String
  message String?

  executedAt DateTime @default(now())
  lockId     String?

  steps AutomationRunStep[]

  @@index([workspaceId, executedAt])
  @@index([automationId])
  @@index([contactId])
  @@index([listingId])
  @@index([status])
}

model AutomationRunStep {
  id    String @id @default(cuid())
  runId String

  stepId     String?
  stepIndex  Int
  stepType   String
  status     String
  message    String?
  executedAt DateTime @default(now())
  payload    Json?

  run AutomationRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@index([stepType])
  @@index([status])
}

// ---------------------------
// SMS
// ---------------------------
model SmsSuppression {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  createdByUserId String?
  createdByUser   User?   @relation("SmsSuppressionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  phone  String
  reason String @default("STOP")

  createdAt DateTime @default(now())

  @@unique([workspaceId, phone])
  @@index([workspaceId, phone])
  @@index([createdByUserId])
}

model SmsMessage {
  id String @id @default(cuid())

  // Tenant boundary (strict)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  createdByUserId String?
  createdByUser   User?   @relation("SmsMessageCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  contactId  String?
  direction  SmsDirection
  fromNumber String
  toNumber   String
  body       String
  twilioSid  String?
  status     String?
  error      String?

  createdAt DateTime @default(now())

  @@index([workspaceId, createdAt])
  @@index([workspaceId, toNumber])
  @@index([contactId])
  @@index([createdByUserId])
}
